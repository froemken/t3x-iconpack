/*
 * This file is part of the "iconpack" Extension for TYPO3 CMS.
 *
 * Conceived and written by Stephan Kellermayr
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 */
define(['jquery','TYPO3/CMS/Backend/Modal','TYPO3/CMS/Core/Ajax/AjaxRequest','TYPO3/CMS/Backend/Icons'],(function(i,e,n,t){'use strict';let l;return l||(l=new class{constructor(){this.$imodal=null,this.fieldType=null,this.iconfig=null,this.iconfigBackup=null,this.editor=null,this.sel={palette:'.t3js-formengine-palette-field',formengineInput:'formengine-input-name',iconField:'.t3js-icon',modalFooter:'.modal-footer',styles:'#iconpack-style',options:'#iconpack-options',icons:'#iconpack-icons',iconSelection:'#iconpack-selected > div',search:'#iconpack-search',optionsSection:'.form-section',styleSheets:'#iconpack-stylesheets'},this.el={$palette:null,$formengineInput:null,$iconField:null,$modalFooter:null,$styles:null,$options:null,$icons:null,$iconSelection:null,$search:null,$optionsSection:null}}showFieldIconModal(n){n=i(n),this.fieldType='native',this.el.$palette=n.closest(this.sel.palette),this.el.$formengineInput=this.el.$palette.find('input[name="'+n.data(this.sel.formengineInput)+'"]'),this.el.$iconField=n.find(l.sel.iconField);let t=this.el.$formengineInput.val();this.iconfig=this.convertIconfigToObject(t),this.iconfigBackup=this.iconfig,this.createModal(TYPO3.settings.ajaxUrls.iconpack_modal+'&fieldType='+this.fieldType+'&iconfig='+t,TYPO3.lang['js.label.iconNative']).on('button.clicked',(function(i){l.$imodal.find('.modal-body').css('display','none'),'ok'===i.target.name?l.ajaxRequest(TYPO3.settings.ajaxUrls.iconpack_icon,l.addIconToField,l.convertIconfigToString(l.iconfig)):'clear'===i.target.name&&l.addIconToField(null,''),e.dismiss(l.unlinkCSS())}))}showCkeditorModal(i){this.editor=i,this.fieldType='rte',this.iconfig=null,this.iconfigBackup=this.iconfig,this.createModal(TYPO3.settings.ajaxUrls.iconpack_modal+'&fieldType='+this.fieldType,TYPO3.lang['js.label.iconRte']).on('button.clicked',(function(i){'ok'===i.target.name&&l.ajaxRequest(TYPO3.settings.ajaxUrls.iconpack_icon,l.addIconToRte,l.convertIconfigToString(l.iconfig)),e.dismiss(l.unlinkCSS())}))}createModal(n,t){let o=[{text:i(this).data('button-cancel-text')||TYPO3.lang['js.button.cancel']||'Cancel',active:!0,name:'cancel'},{text:i(this).data('button-ok-text')||TYPO3.lang['js.button.ok']||'OK',btnClass:'btn-success',name:'ok'}];return this.iconfig&&o.unshift({text:i(this).data('button-clear-text')||TYPO3.lang['js.button.clear']||'Clear',btnClass:'btn-warning',name:'clear'}),e.advanced({type:e.types.ajax,title:t,content:n,buttons:o,size:e.sizes.large,callback:function(i){i.find('.t3js-modal-content').addClass('modal-iconpack'),l.$imodal=i},ajaxCallback:function(){l.initializeContent()}})}ajaxRequest(i,e,t){new n(i).withQueryArguments({fieldType:l.fieldType,iconfig:t}).get().then((async function(i){const n=await i.resolve();n&&e(n,t)}))}addIconToField(i,e){let n='';i&&i.icon&&(n=i.icon?l.convertIcon(i.icon,e):''),l.el.$formengineInput.val(e),l.el.$palette.addClass('has-change'),l.el.$iconField.html(n)}addIconToRte(i,e){i&&i.icon&&l.editor.insertElement(CKEDITOR.dom.element.createFromHtml(l.convertIcon(i.icon,e)+'&nbsp'))}updateContent(i,e){l.el.$search.find('input').val(''),null!==i.iconpackOptions&&l.el.$options.html(i.iconpackOptions),null!==i.iconpackIcons&&l.el.$icons.html(i.iconpackIcons),l.initializeOptionFields(),l.initializeIconWall()}initializeContent(){l.el.$modalFooter=l.$imodal.find(l.sel.modalFooter),l.el.$styles=l.$imodal.find(l.sel.styles),l.el.$options=l.$imodal.find(l.sel.options),l.el.$icons=l.$imodal.find(l.sel.icons),l.el.$iconSelection=l.$imodal.find(l.sel.iconSelection),l.el.$search=l.$imodal.find(l.sel.search),l.injectCSS(),l.el.$styles&&0!==l.el.$styles.length?(l.initializeStyleField(),l.initializeOptionFields(),l.initializeIconWall(),l.initializeSearchField()):(l.el.$modalFooter.find('.btn-success').css('display','none'),l.el.$modalFooter.find('.btn-warning').css('display','none'))}initializeStyleField(){l.el.$styles.on('change',(function(){t.getIcon('spinner-circle',t.sizes.default,null,null,t.markupIdentifiers.inline).then(i=>{l.el.$icons.html('<div class="icons-loading">'+i+'</div>')}),l.iconfig=l.convertIconfigToObject(i(this).val()),l.iconfigBackup&&l.iconfigBackup.iconpack&&(l.iconfigBackup.iconpackStyle===l.iconfig.iconpackStyle?l.iconfig=l.iconfigBackup:l.iconfigBackup.iconpack===l.iconfig.iconpack&&(l.iconfig.options=l.iconfigBackup.options)),l.ajaxRequest(TYPO3.settings.ajaxUrls.iconpack_modal_update,l.updateContent,i(this).val())}))}initializeOptionFields(){l.el.$options.find('.iconpack-option').each((function(){let e=i(this),n=e.data('key');l.iconfig&&l.iconfig.options[n]&&l.setFieldValue(e,l.iconfig.options[n]),e.on('change',(function(){let i=l.iconfig.icon;if(i){let e=l.el.$icons.find('[name="'+i+'"]').html();l.el.$iconSelection.html(e)}l.applyOptions()}))}))}getFieldAttributes(i){if(i)if(i.is(':checkbox')){if(i.is(':checked'))return i.data('attributes')}else if(i.is('select')){let e=i.val();if(e)return i.find('[value='+e+']').data('attributes')}}getFieldValue(i){if(i){if(i.is(':checkbox'))return!!i.is(':checked');if(i.is('select'))return i.val()}return null}setFieldValue(i,e){i&&(i.is(':checkbox')?e&&i.prop('checked',e):i.is('select')&&i.val(e))}initializeSearchField(){let i=l.el.$search.find('input'),e=l.el.$search.find('button.close');l.el.$search.detach().prependTo(l.el.$modalFooter),e.click((function(){i.val('').trigger('input')})),i.on('input',(function(){let n=i.val();''!==n?e.css('visibility','visible'):e.css('visibility','hidden'),l.searchIcon(n)}))}initializeIconWall(){l.el.$icons.find('li').each((function(){let e=i(this),n=e.attr('name');l.iconfig&&l.iconfig.icon&&l.iconfig.icon===n&&i(this).addClass('active'),e.click((function(){i(this).closest('section').parent().find('li').removeClass('active'),i(this).addClass('active'),l.selectIcon(n)}))}))}selectIcon(i){let e=l.el.$styles.val(),n=l.el.$icons.find('[name="'+i+'"]').html();l.el.$iconSelection.html(n),l.iconfig=l.convertIconfigToObject(e+','+i),l.applyOptions()}applyOptions(){let e=[],n={options:{}};l.el.$options.find('.iconpack-option').each((function(){let t=i(this),o=t.data('key'),c=l.getFieldAttributes(t);c&&e.push(c);let s=l.getFieldValue(t);s&&(n.options[o]=s)})),l.mergeIconfig(n),l.mergeAttributesIntoIconSelection(e)}mergeAttributesIntoIconSelection(e){let n=l.el.$iconSelection.children().first();i.each(e,(function(e,t){i.each(t,(function(i,e){switch(i){case'class':n.addClass(e);break;case'style':n.css(e);break;default:n.attr(i,e)}}))}))}searchIcon(e){l.el.$icons.find('section').each((function(){let n=i(this),t=!1;n.find('li').each((function(){let n=i(this),l=n.attr('name');l&&l.indexOf(e)>=0?(n.css('display','inline-flex'),t=!0):n.css('display','none')})),t?n.css('display','block'):n.css('display','none')}))}convertIcon(e,n){let t=null;if(e)if(e.attributes['data-iconfig']=n,t=i('<'+e.elementName+'>',e.attributes),''===e.innerHtml)t.html(' ');else{if('svgInline'===e.type){let e=i.parseXML(t.prop('outerHTML'));t=i(e).find('svg')}t.html(e.innerHtml)}return t?t.prop('outerHTML'):''}injectCSS(){let e=l.$imodal.find(l.sel.styleSheets).val();e&&e.length&&(e=JSON.parse(e),i.each(e,(function(e,n){if(!window.parent.$('link[href="'+n+'"]').length){let t=i('<link />',{rel:'stylesheet',type:'text/css',href:n,name:'iconpack['+e+']'});window.parent.$('head').append(t)}})))}unlinkCSS(){let e=window.parent.$('link[name^=iconpack]');e.length&&i.each(e,(function(i,e){e.remove()}))}convertIconfigToObject(i){let e=null;if(i){let n=(i=i.split(','))[0].split(':');e={iconpackStyle:i[0]||null,iconpack:n[0]||null,style:n[1]||null,icon:i[1]||null,options:{}};for(let n=2;n<i.length;n++){let t=i[n].split(':');e.options[t[0]]=t[1]}}return e}convertIconfigToString(i){let e='';if(i&&(e=i.iconpackStyle+','+i.icon,i.options))for(var n in i.options)e+=','+n+':'+i.options[n];return e}mergeIconfig(i){l.iconfig={...l.iconfig,...i},l.iconfigBackup=l.iconfig}}),l}));
